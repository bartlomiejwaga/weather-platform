name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    steps:
      - name: PR Details
        run: |
          echo "## Pull Request Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commits:** ${{ github.event.pull_request.commits }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changed Files:** ${{ github.event.pull_request.changed_files }}" >> $GITHUB_STEP_SUMMARY

  backend-tests:
    name: Backend Tests (All)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: weather_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      working-directory: ./backend
      run: chmod +x gradlew

    - name: Run all tests
      working-directory: ./backend
      run: ./gradlew test --no-daemon

    - name: Run integration tests explicitly
      working-directory: ./backend
      run: ./gradlew test --tests "*IntegrationTest" --no-daemon

    - name: Generate coverage report
      working-directory: ./backend
      run: ./gradlew jacocoTestReport --no-daemon

    - name: Comment test results on PR
      uses: mikepenz/action-junit-report@v4
      if: always()
      with:
        report_paths: 'backend/build/test-results/test/*.xml'
        check_name: 'Backend Test Results (PR)'
        detailed_summary: true
        include_passed: true
        fail_on_failure: true

    - name: Add coverage comment to PR
      uses: madrapps/jacoco-report@v1.6.1
      if: github.event_name == 'pull_request'
      with:
        paths: backend/build/reports/jacoco/test/jacocoTestReport.xml
        token: ${{ secrets.GITHUB_TOKEN }}
        min-coverage-overall: 60
        min-coverage-changed-files: 70
        title: Backend Code Coverage

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Run linter
      working-directory: ./frontend
      run: npm run lint

    - name: Run tests with coverage
      working-directory: ./frontend
      run: npm test -- --run --coverage

    - name: Build
      working-directory: ./frontend
      run: npm run build

  code-style:
    name: Code Style & Formatting
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Check Java code style
      working-directory: ./backend
      run: |
        chmod +x gradlew
        ./gradlew checkstyleMain checkstyleTest || echo "Checkstyle warnings found"

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Check frontend code style
      working-directory: ./frontend
      run: |
        npm ci
        npm run lint

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate

  pr-size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    steps:
    - name: Check PR size
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const additions = pr.additions;
          const deletions = pr.deletions;
          const changedFiles = pr.changed_files;

          let size = 'small';
          let emoji = 'ðŸŸ¢';

          if (additions + deletions > 1000 || changedFiles > 30) {
            size = 'large';
            emoji = 'ðŸ”´';
          } else if (additions + deletions > 500 || changedFiles > 15) {
            size = 'medium';
            emoji = 'ðŸŸ¡';
          }

          core.summary
            .addHeading('PR Size Check')
            .addRaw(`${emoji} This PR is **${size}**`)
            .addTable([
              [{data: 'Metric', header: true}, {data: 'Value', header: true}],
              ['Additions', `+${additions}`],
              ['Deletions', `-${deletions}`],
              ['Changed Files', `${changedFiles}`],
              ['Total Changes', `${additions + deletions}`]
            ])
            .write();

          if (size === 'large') {
            core.warning('This PR is quite large. Consider breaking it into smaller PRs for easier review.');
          }

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, code-style]
    if: always()

    steps:
    - name: Generate PR summary
      run: |
        echo "## Pull Request Check Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Tests | ${{ needs.backend-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Tests | ${{ needs.frontend-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Code Style | ${{ needs.code-style.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.backend-tests.result }}" == "success" ] && \
           [ "${{ needs.frontend-tests.result }}" == "success" ] && \
           [ "${{ needs.code-style.result }}" == "success" ]; then
          echo "### âœ… All checks passed! This PR is ready for review." >> $GITHUB_STEP_SUMMARY
          exit 0
        else
          echo "### âŒ Some checks failed. Please fix the issues before merging." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
